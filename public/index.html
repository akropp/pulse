<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Swarmboard — Project Status</title>
<style>
:root {
  --bg:          #0d1117;
  --bg-card:     #161b22;
  --bg-input:    #0d1117;
  --bg-hover:    #1c2128;
  --bg-modal:    #161b22;
  --border:      #30363d;
  --border-focus:#58a6ff;
  --text:        #e6edf3;
  --text-muted:  #8b949e;
  --text-dim:    #6e7681;
  --accent:      #58a6ff;
  --accent-bg:   #1f6feb20;
  --success:     #3fb950;
  --warning:     #d29922;
  --danger:      #f85149;
  --tag-owner:   #388bfd20;
  --tag-contrib: #56d36420;
  --tag-watcher: #8b949e20;
  --radius:      8px;
  --radius-sm:   4px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.5;
}

/* ── Nav ── */
nav {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  flex-shrink: 0;
}

.logo-pulse {
  width: 22px; height: 22px;
  background: linear-gradient(135deg, #58a6ff, #3fb950);
  border-radius: 50%;
  display: inline-block;
  box-shadow: 0 0 8px #58a6ff55;
}

.nav-tabs {
  display: flex;
  gap: 4px;
  flex: 1;
}

.nav-tab {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px 14px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  transition: all 0.15s;
}

.nav-tab:hover { background: var(--bg-hover); color: var(--text); }
.nav-tab.active { background: var(--accent-bg); color: var(--accent); }

.nav-actions { display: flex; gap: 8px; align-items: center; }

/* ── Buttons ── */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text);
  cursor: pointer;
  padding: 6px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  transition: all 0.15s;
  text-decoration: none;
  white-space: nowrap;
}
.btn:hover { background: var(--bg-hover); border-color: #8b949e; }

.btn-primary {
  background: #238636;
  border-color: #2ea043;
  color: #fff;
}
.btn-primary:hover { background: #2ea043; border-color: #3fb950; }

.btn-danger { border-color: var(--danger); color: var(--danger); }
.btn-danger:hover { background: #f851491a; }

.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn-icon { padding: 4px 8px; border: none; background: none; cursor: pointer; color: var(--text-muted); border-radius: var(--radius-sm); font-size: 16px; }
.btn-icon:hover { background: var(--bg-hover); color: var(--text); }

/* ── Main Layout ── */
.main { padding: 24px; max-width: 1400px; margin: 0 auto; }

.view { display: none; }
.view.active { display: block; }

/* ── Search / Filter bar ── */
.toolbar {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 200px;
  max-width: 400px;
  position: relative;
}
.search-box input {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  padding: 7px 12px 7px 32px;
  font-size: 14px;
}
.search-box::before {
  content: '⌕';
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-dim);
  pointer-events: none;
  font-size: 16px;
}
input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px #58a6ff18;
}

.filter-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px 12px;
  font-size: 13px;
}
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

.stat-pill {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
}
.stat-pill span { color: var(--text); font-weight: 600; }

/* ── Projects Grid ── */
.projects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 16px;
}

.project-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.15s, box-shadow 0.15s;
  cursor: pointer;
}
.project-card:hover {
  border-color: #8b949e;
  box-shadow: 0 4px 16px #00000040;
}
.project-card.expanded { border-color: var(--accent); }
.project-card.archived { opacity: 0.6; }

.card-header {
  padding: 16px 16px 0;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  flex: 1;
}

.card-id {
  font-size: 11px;
  color: var(--text-dim);
  font-family: 'SF Mono', Consolas, monospace;
  margin-top: 2px;
}

.card-actions { display: flex; gap: 4px; flex-shrink: 0; }

.card-body { padding: 12px 16px; }

.card-description {
  color: var(--text-muted);
  font-size: 13px;
  margin-bottom: 10px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-members {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 10px;
}

.member-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 20px;
  border: 1px solid var(--border);
}
.member-badge.owner     { background: var(--tag-owner);   border-color: #388bfd50; color: #79c0ff; }
.member-badge.contributor { background: var(--tag-contrib); border-color: #56d36450; color: #7ee787; }
.member-badge.watcher   { background: var(--tag-watcher); border-color: #6e768150; color: #8b949e; }

.card-status {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  margin-bottom: 12px;
}
.card-status.empty { color: var(--text-dim); font-style: italic; font-size: 13px; }

.status-text {
  color: var(--text);
  font-size: 13px;
  line-height: 1.5;
  margin-bottom: 4px;
}
.status-meta {
  font-size: 11px;
  color: var(--text-dim);
  display: flex;
  gap: 8px;
}
.status-meta .author { color: var(--text-muted); }

.card-footer {
  padding: 0 16px 14px;
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

/* ── History panel ── */
.card-history {
  border-top: 1px solid var(--border);
  padding: 14px 16px;
  display: none;
}
.project-card.expanded .card-history { display: block; }

.history-header {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  margin-bottom: 10px;
}

.history-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }

.history-item {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  background: var(--bg);
}
.history-item-text { font-size: 13px; color: var(--text); margin-bottom: 4px; }
.history-item-meta { font-size: 11px; color: var(--text-dim); }
.history-item-meta .h-author { color: var(--text-muted); }

/* ── Empty state ── */
.empty-state {
  text-align: center;
  padding: 80px 24px;
  color: var(--text-muted);
}
.empty-state h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }
.empty-state p { font-size: 14px; margin-bottom: 20px; }

/* ── Hooks View ── */
.hooks-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

@media (max-width: 900px) { .hooks-layout { grid-template-columns: 1fr; } }

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.panel-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg);
}
.panel-title { font-size: 14px; font-weight: 600; }

.panel-body { padding: 16px; }

.hook-list { display: flex; flex-direction: column; gap: 8px; }

.hook-item {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  gap: 10px;
  align-items: flex-start;
}
.hook-item:hover { background: var(--bg-hover); border-color: #8b949e; }
.hook-item.selected { border-color: var(--accent); background: var(--accent-bg); }

.hook-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 4px;
}
.hook-dot.enabled { background: var(--success); }
.hook-dot.disabled { background: var(--text-dim); }

.hook-info { flex: 1; min-width: 0; }
.hook-name { font-weight: 500; }
.hook-url {
  font-size: 11px;
  color: var(--text-dim);
  font-family: monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.hook-item-actions { display: flex; gap: 4px; flex-shrink: 0; }

/* ── Log entries ── */
.log-list { display: flex; flex-direction: column; gap: 6px; }
.log-entry {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  display: flex;
  gap: 8px;
  align-items: baseline;
}
.log-entry.success { border-color: #3fb95030; background: #3fb95010; }
.log-entry.error   { border-color: #f8514930; background: #f8514910; }
.log-time { color: var(--text-dim); flex-shrink: 0; }
.log-event { color: var(--accent); font-family: monospace; flex-shrink: 0; }
.log-status { font-weight: 600; }
.log-status.ok  { color: var(--success); }
.log-status.err { color: var(--danger); }
.log-body { color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

/* ── Modal ── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #00000088;
  z-index: 500;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 100%;
  max-width: 540px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 16px 40px #000000a0;
}

.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}
.modal-title { font-size: 16px; font-weight: 600; }

.modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  flex-shrink: 0;
}

/* ── Forms ── */
.form-group { margin-bottom: 16px; }

label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 6px;
}
label .required { color: var(--danger); margin-left: 2px; }
label .hint { font-weight: 400; color: var(--text-dim); font-size: 11px; }

input[type=text], input[type=url], textarea, select {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  padding: 8px 10px;
  font-size: 14px;
  font-family: inherit;
}
select { cursor: pointer; }
textarea { resize: vertical; min-height: 80px; font-family: 'SF Mono', Consolas, monospace; font-size: 12px; }

input[type=checkbox] { width: auto; cursor: pointer; margin-right: 6px; }

.checkbox-row { display: flex; align-items: center; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* ── Tabs within modal ── */
.tab-group {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}
.tab-btn {
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-muted);
  cursor: pointer;
  padding: 8px 16px;
  font-size: 13px;
  margin-bottom: -1px;
  transition: all 0.15s;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* ── Notification management ── */
.sub-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.sub-item:last-child { border-bottom: none; }
.sub-name { flex: 1; font-size: 13px; }
.sub-filter { font-size: 11px; color: var(--text-dim); font-family: monospace; }

/* ── Toast ── */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  font-size: 13px;
  max-width: 320px;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.2s;
  pointer-events: auto;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { border-color: var(--success); background: #3fb95015; color: var(--success); }
.toast.error   { border-color: var(--danger);  background: #f8514915; color: var(--danger); }

/* ── Badge ── */
.badge {
  display: inline-block;
  font-size: 11px;
  font-weight: 600;
  padding: 1px 7px;
  border-radius: 20px;
  border: 1px solid;
}
.badge-active   { color: var(--success); border-color: var(--success); background: #3fb95015; }
.badge-archived { color: var(--text-dim); border-color: var(--text-dim); background: transparent; }

/* ── Loading ── */
.spinner { animation: spin 0.7s linear infinite; display: inline-block; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #8b949e; }

/* ── Responsive ── */
@media (max-width: 600px) {
  .projects-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  nav { padding: 0 12px; }
  .main { padding: 12px; }
}
</style>
</head>
<body>

<nav>
  <a class="logo" href="#">
    <span class="logo-pulse"></span>
    Pulse
  </a>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showView('projects')" id="tab-projects">Projects</button>
    <button class="nav-tab" onclick="showView('hooks')" id="tab-hooks">Hooks</button>
  </div>
  <div class="nav-actions">
    <span class="stat-pill" id="stat-pill">Loading…</span>
    <button class="btn btn-primary" onclick="openModal('create-project')">+ New Project</button>
  </div>
</nav>

<div class="main">

  <!-- ── Projects View ── -->
  <div id="view-projects" class="view active">
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Search projects…" oninput="renderProjects()">
      </div>
      <button class="filter-btn" id="filter-archived" onclick="toggleArchivedFilter()">Show archived</button>
      <button class="btn btn-sm" onclick="loadAll()" title="Refresh">↺ Refresh</button>
    </div>
    <div id="projects-grid" class="projects-grid">
      <div class="empty-state"><p><span class="spinner">↻</span> Loading…</p></div>
    </div>
  </div>

  <!-- ── Hooks View ── -->
  <div id="view-hooks" class="view">
    <div class="hooks-layout">
      <!-- Hook definitions -->
      <div>
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">Webhook Definitions</span>
            <button class="btn btn-sm btn-primary" onclick="openModal('create-hook')">+ Add Hook</button>
          </div>
          <div class="panel-body">
            <div id="hooks-list" class="hook-list">
              <p style="color:var(--text-dim)">Loading…</p>
            </div>
          </div>
        </div>
        <!-- Hook log -->
        <div class="panel" style="margin-top:16px">
          <div class="panel-header">
            <span class="panel-title" id="log-panel-title">Execution Log</span>
            <button class="btn btn-sm" onclick="loadHookLog()">↺</button>
          </div>
          <div class="panel-body">
            <div id="hook-log-list" style="color:var(--text-dim);font-size:13px">Select a hook to see its log</div>
          </div>
        </div>
      </div>
      <!-- Hook editor / details -->
      <div>
        <div class="panel" id="hook-editor-panel">
          <div class="panel-header">
            <span class="panel-title" id="hook-editor-title">Hook Details</span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm" id="hook-test-btn" onclick="testSelectedHook()" style="display:none">Test</button>
              <button class="btn btn-sm btn-danger" id="hook-delete-btn" onclick="deleteSelectedHook()" style="display:none">Delete</button>
            </div>
          </div>
          <div class="panel-body" id="hook-editor-body">
            <p style="color:var(--text-muted);font-size:13px">Select a hook to view or edit details, or click "+ Add Hook" to create one.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     MODALS
════════════════════════════════════════════════════════════════════════ -->

<!-- Create Project -->
<div class="modal-overlay" id="modal-create-project" onclick="if(event.target===this) closeModal('create-project')">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Project</span>
      <button class="btn-icon" onclick="closeModal('create-project')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Name <span class="required">*</span></label>
        <input type="text" id="cp-name" placeholder="My Awesome Project" autofocus>
      </div>
      <div class="form-group">
        <label>ID <span class="hint">(auto-generated if blank)</span></label>
        <input type="text" id="cp-id" placeholder="my-awesome-project">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="cp-desc" rows="2" placeholder="What is this project about?"></textarea>
      </div>
      <div class="form-group">
        <label>Initial Members <span class="hint">(name:role, one per line)</span></label>
        <textarea id="cp-members" rows="2" placeholder="alice:owner&#10;bob:contributor"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('create-project')">Cancel</button>
      <button class="btn btn-primary" onclick="createProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- Edit Project -->
<div class="modal-overlay" id="modal-edit-project" onclick="if(event.target===this) closeModal('edit-project')">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Edit Project</span>
      <button class="btn-icon" onclick="closeModal('edit-project')">✕</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ep-id">
      <div class="tab-group">
        <button class="tab-btn active" onclick="switchTab('ep', 'details')">Details</button>
        <button class="tab-btn" onclick="switchTab('ep', 'members')">Members</button>
        <button class="tab-btn" onclick="switchTab('ep', 'notifications')">Notifications</button>
      </div>
      <!-- Details tab -->
      <div class="tab-pane active" id="ep-tab-details">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="ep-name">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="ep-desc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <div class="checkbox-row">
            <input type="checkbox" id="ep-archived">
            <label for="ep-archived" style="margin-bottom:0;cursor:pointer">Archived</label>
          </div>
        </div>
      </div>
      <!-- Members tab -->
      <div class="tab-pane" id="ep-tab-members">
        <div id="ep-members-list" style="margin-bottom:12px"></div>
        <div style="display:flex;gap:8px">
          <input type="text" id="ep-member-name" placeholder="Member name" style="flex:1">
          <select id="ep-member-role" style="width:140px">
            <option value="owner">owner</option>
            <option value="contributor" selected>contributor</option>
            <option value="watcher">watcher</option>
          </select>
          <button class="btn btn-sm btn-primary" onclick="addMember()">Add</button>
        </div>
      </div>
      <!-- Notifications tab -->
      <div class="tab-pane" id="ep-tab-notifications">
        <div id="ep-subs-list" style="margin-bottom:14px"></div>
        <div style="display:flex;gap:8px;align-items:flex-start">
          <select id="ep-sub-hook" style="flex:1">
            <option value="">— select hook —</option>
          </select>
          <input type="text" id="ep-sub-filter" placeholder="events (blank=all)" style="width:160px">
          <button class="btn btn-sm btn-primary" onclick="addSubscription()">Subscribe</button>
        </div>
        <p style="color:var(--text-dim);font-size:11px;margin-top:6px">Events: status, member, archive, edit (comma-separated; blank = all)</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="archiveProject()">Archive</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal('edit-project')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save</button>
    </div>
  </div>
</div>

<!-- Post Status Update -->
<div class="modal-overlay" id="modal-post-status" onclick="if(event.target===this) closeModal('post-status')">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Post Status Update</span>
      <button class="btn-icon" onclick="closeModal('post-status')">✕</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ps-project-id">
      <div class="form-group">
        <label id="ps-project-label">Project</label>
      </div>
      <div class="form-group">
        <label>Author <span class="required">*</span></label>
        <input type="text" id="ps-author" placeholder="your-name">
      </div>
      <div class="form-group">
        <label>Status Update <span class="required">*</span></label>
        <textarea id="ps-text" rows="4" placeholder="What's the current status?"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('post-status')">Cancel</button>
      <button class="btn btn-primary" onclick="postStatus()">Post Update</button>
    </div>
  </div>
</div>

<!-- Create Hook -->
<div class="modal-overlay" id="modal-create-hook" onclick="if(event.target===this) closeModal('create-hook')">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <span class="modal-title">Add Webhook Hook</span>
      <button class="btn-icon" onclick="closeModal('create-hook')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>ID <span class="required">*</span> <span class="hint">(unique slug)</span></label>
          <input type="text" id="ch-id" placeholder="notify-slack">
        </div>
        <div class="form-group">
          <label>Name <span class="required">*</span></label>
          <input type="text" id="ch-name" placeholder="Slack #general">
        </div>
      </div>
      <div class="form-group">
        <label>Webhook URL <span class="required">*</span></label>
        <input type="url" id="ch-url" placeholder="https://hooks.slack.com/...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Method</label>
          <select id="ch-method">
            <option value="POST" selected>POST</option>
            <option value="GET">GET</option>
            <option value="PUT">PUT</option>
          </select>
        </div>
        <div class="form-group">
          <label>Headers <span class="hint">(JSON object)</span></label>
          <input type="text" id="ch-headers" placeholder='{"Authorization":"Bearer xxx"}'>
        </div>
      </div>
      <div class="form-group">
        <label>Body Template <span class="hint">(Mustache; {{project.name}}, {{update.author}}, {{update.text}})</span></label>
        <textarea id="ch-template" rows="6" placeholder='{"text":"{{project.name}}: {{update.text}}"}'></textarea>
      </div>
      <div class="form-group">
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:8px">Quick templates:</p>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-sm" onclick="fillTemplate('slack')">Slack</button>
          <button class="btn btn-sm" onclick="fillTemplate('openclaw')">OpenClaw</button>
          <button class="btn btn-sm" onclick="fillTemplate('discord')">Discord</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('create-hook')">Cancel</button>
      <button class="btn btn-primary" onclick="createHook()">Create Hook</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
// ════════════════════════════════════════════════════════════
// State
// ════════════════════════════════════════════════════════════
let projects = [];
let hooks = [];
let expandedProjectId = null;
let selectedHookId = null;
let historyCache = {};
let showArchived = false;
let currentView = 'projects';
let refreshTimer = null;

// ════════════════════════════════════════════════════════════
// API
// ════════════════════════════════════════════════════════════
// Detect base path from current URL (handles reverse proxy at /pulse etc.)
const BASE_PATH = (() => {
  const p = window.location.pathname.replace(/\/+$/, '');
  // If served at /pulse, API calls go to /pulse/projects etc.
  // If served at /, API calls go to /projects etc.
  return p === '' ? '' : p;
})();

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body !== undefined) opts.body = JSON.stringify(body);
  const res = await fetch(BASE_PATH + path, opts);
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || `HTTP ${res.status}`);
  }
  return res.json();
}

// ════════════════════════════════════════════════════════════
// Load data
// ════════════════════════════════════════════════════════════
async function loadAll() {
  await Promise.all([loadProjects(), loadHooks()]);
  renderProjects();
  renderHooks();
  updateStatPill();
}

async function loadProjects() {
  try {
    const q = showArchived ? '?archived=true' : '';
    projects = await api('GET', `/projects${q}`);
  } catch (e) {
    toast('Failed to load projects: ' + e.message, 'error');
  }
}

async function loadHooks() {
  try {
    hooks = await api('GET', '/hooks');
  } catch (e) {
    toast('Failed to load hooks: ' + e.message, 'error');
  }
}

async function loadHistory(projectId) {
  try {
    const history = await api('GET', `/projects/${projectId}/history?limit=50`);
    historyCache[projectId] = history;
    return history;
  } catch (e) {
    return [];
  }
}

function updateStatPill() {
  const active = projects.filter(p => !p.archived).length;
  document.getElementById('stat-pill').innerHTML =
    `<span>${active}</span> project${active !== 1 ? 's' : ''}`;
}

// ════════════════════════════════════════════════════════════
// Render Projects
// ════════════════════════════════════════════════════════════
function renderProjects() {
  const query = (document.getElementById('search-input').value || '').toLowerCase();
  const grid = document.getElementById('projects-grid');

  let filtered = projects.filter(p => {
    if (!showArchived && p.archived) return false;
    if (!query) return true;
    return (
      p.name.toLowerCase().includes(query) ||
      p.id.toLowerCase().includes(query) ||
      (p.description || '').toLowerCase().includes(query) ||
      (p.latest_status || '').toLowerCase().includes(query)
    );
  });

  if (!filtered.length) {
    grid.innerHTML = `<div class="empty-state">
      <h2>${query ? 'No matches' : 'No projects yet'}</h2>
      <p>${query ? 'Try a different search term.' : 'Create your first project to get started.'}</p>
      ${!query ? '<button class="btn btn-primary" onclick="openModal(\'create-project\')">+ New Project</button>' : ''}
    </div>`;
    return;
  }

  grid.innerHTML = filtered.map(p => renderProjectCard(p)).join('');
}

function renderProjectCard(p) {
  const isExpanded = expandedProjectId === p.id;
  const members = (p.members || []).map(m =>
    `<span class="member-badge ${m.role || 'contributor'}" title="${m.role}">${m.member_name}</span>`
  ).join('');

  const latestStatus = p.latest_status
    ? `<div class="card-status">
        <div class="status-text">${esc(p.latest_status)}</div>
        <div class="status-meta">
          <span class="author">${esc(p.latest_author || '?')}</span>
          <span>${timeAgo(p.latest_at)}</span>
        </div>
       </div>`
    : `<div class="card-status empty">No status updates yet</div>`;

  const historyHtml = isExpanded ? renderHistoryPanel(p.id) : '';

  return `<div class="project-card${isExpanded ? ' expanded' : ''}${p.archived ? ' archived' : ''}"
               id="card-${p.id}" onclick="toggleProject('${p.id}', event)">
    <div class="card-header">
      <div>
        <div class="card-title">${esc(p.name)}${p.archived ? ' <span class="badge badge-archived" style="font-size:10px">archived</span>' : ''}</div>
        <div class="card-id">${esc(p.id)}</div>
      </div>
      <div class="card-actions" onclick="event.stopPropagation()">
        <button class="btn-icon" title="Post Update" onclick="openPostStatus('${p.id}', '${esc(p.name)}')">✚</button>
        <button class="btn-icon" title="Edit" onclick="openEditProject('${p.id}')">✎</button>
      </div>
    </div>
    <div class="card-body">
      ${p.description ? `<div class="card-description">${esc(p.description)}</div>` : ''}
      ${members ? `<div class="card-members">${members}</div>` : ''}
      ${latestStatus}
    </div>
    <div class="card-footer" onclick="event.stopPropagation()">
      <button class="btn btn-sm" onclick="openPostStatus('${p.id}', '${esc(p.name)}')">Post Update</button>
      <button class="btn btn-sm" onclick="openEditProject('${p.id}')">Edit</button>
    </div>
    <div class="card-history" id="history-${p.id}">
      ${historyHtml}
    </div>
  </div>`;
}

function renderHistoryPanel(projectId) {
  const history = historyCache[projectId] || [];
  if (!history.length) {
    return `<div class="history-header">Status History</div>
            <p style="color:var(--text-dim);font-size:13px">No history yet.</p>`;
  }
  const items = history.map(u => `
    <div class="history-item">
      <div class="history-item-text">${esc(u.status_text)}</div>
      <div class="history-item-meta">
        <span class="h-author">${esc(u.author)}</span> · ${timeAgo(u.created_at)}
      </div>
    </div>`).join('');
  return `<div class="history-header">Status History (${history.length})</div>
          <div class="history-list">${items}</div>`;
}

async function toggleProject(projectId, event) {
  if (event && event.target.tagName === 'BUTTON') return;
  if (expandedProjectId === projectId) {
    expandedProjectId = null;
  } else {
    expandedProjectId = projectId;
    if (!historyCache[projectId]) {
      await loadHistory(projectId);
    }
  }
  renderProjects();
}

// ════════════════════════════════════════════════════════════
// Render Hooks
// ════════════════════════════════════════════════════════════
function renderHooks() {
  const list = document.getElementById('hooks-list');
  if (!hooks.length) {
    list.innerHTML = '<p style="color:var(--text-dim);font-size:13px">No hooks defined. Add one to start routing notifications.</p>';
    return;
  }
  list.innerHTML = hooks.map(h => `
    <div class="hook-item${selectedHookId === h.id ? ' selected' : ''}" onclick="selectHook('${h.id}')">
      <div class="hook-dot ${h.enabled ? 'enabled' : 'disabled'}"></div>
      <div class="hook-info">
        <div class="hook-name">${esc(h.name)}</div>
        <div class="hook-url">${esc(h.url)}</div>
      </div>
    </div>`).join('');
}

function selectHook(hookId) {
  selectedHookId = hookId;
  renderHooks();
  renderHookEditor();
  loadHookLog();
}

function renderHookEditor() {
  const hook = hooks.find(h => h.id === selectedHookId);
  const titleEl = document.getElementById('hook-editor-title');
  const bodyEl  = document.getElementById('hook-editor-body');
  const testBtn  = document.getElementById('hook-test-btn');
  const delBtn   = document.getElementById('hook-delete-btn');

  if (!hook) {
    titleEl.textContent = 'Hook Details';
    bodyEl.innerHTML = '<p style="color:var(--text-muted);font-size:13px">Select a hook to view or edit.</p>';
    testBtn.style.display = 'none';
    delBtn.style.display = 'none';
    return;
  }

  titleEl.textContent = hook.name;
  testBtn.style.display = '';
  delBtn.style.display = '';

  let headers = {};
  try { headers = JSON.parse(hook.headers_json || '{}'); } catch (_) {}

  bodyEl.innerHTML = `
    <div class="form-group">
      <label>ID</label>
      <input type="text" value="${esc(hook.id)}" readonly style="opacity:0.6;cursor:default">
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="he-name" value="${esc(hook.name)}">
    </div>
    <div class="form-group">
      <label>URL</label>
      <input type="url" id="he-url" value="${esc(hook.url)}">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Method</label>
        <select id="he-method">
          <option${hook.method==='POST'?' selected':''}>POST</option>
          <option${hook.method==='GET'?' selected':''}>GET</option>
          <option${hook.method==='PUT'?' selected':''}>PUT</option>
        </select>
      </div>
      <div class="form-group">
        <label>Enabled</label>
        <div class="checkbox-row" style="padding-top:8px">
          <input type="checkbox" id="he-enabled" ${hook.enabled ? 'checked' : ''}>
          <label for="he-enabled" style="margin-bottom:0;cursor:pointer">Active</label>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>Headers (JSON)</label>
      <input type="text" id="he-headers" value='${esc(JSON.stringify(headers))}'>
    </div>
    <div class="form-group">
      <label>Body Template</label>
      <textarea id="he-template" rows="7">${esc(hook.body_template || '')}</textarea>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px">
      <button class="btn btn-sm" onclick="cancelHookEdit()">Cancel</button>
      <button class="btn btn-sm btn-primary" onclick="saveHook()">Save</button>
    </div>
    <div style="margin-top:16px">
      <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:8px">Project Subscriptions</div>
      <div id="he-subscriptions"><p style="color:var(--text-dim);font-size:13px">Loading…</p></div>
    </div>`;

  loadHookSubscriptions(hook.id);
}

async function loadHookSubscriptions(hookId) {
  const el = document.getElementById('he-subscriptions');
  if (!el) return;
  try {
    // Get all projects that subscribe to this hook
    const subs = [];
    for (const p of projects) {
      const projSubs = await api('GET', `/projects/${p.id}/notifications`);
      const match = projSubs.find(s => s.hook_id === hookId);
      if (match) subs.push({ project: p, sub: match });
    }
    if (!subs.length) {
      el.innerHTML = '<p style="color:var(--text-dim);font-size:13px">No projects subscribed to this hook.</p>';
    } else {
      el.innerHTML = subs.map(({ project, sub }) => `
        <div class="sub-item">
          <span class="sub-name">${esc(project.name)}</span>
          <span class="sub-filter">${sub.event_filter || 'all events'}</span>
          <button class="btn-icon" style="font-size:12px" onclick="unsubProject('${project.id}', '${hookId}')">✕</button>
        </div>`).join('');
    }
  } catch (e) {
    el.innerHTML = `<p style="color:var(--danger);font-size:13px">${esc(e.message)}</p>`;
  }
}

async function unsubProject(projectId, hookId) {
  try {
    await api('DELETE', `/projects/${projectId}/notifications/${hookId}`);
    loadHookSubscriptions(hookId);
    toast('Unsubscribed');
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function loadHookLog() {
  if (!selectedHookId) return;
  const el = document.getElementById('hook-log-list');
  const titleEl = document.getElementById('log-panel-title');
  const hook = hooks.find(h => h.id === selectedHookId);
  if (hook) titleEl.textContent = `Log — ${hook.name}`;

  try {
    const log = await api('GET', `/hooks/${selectedHookId}/log?limit=30`);
    if (!log.length) {
      el.innerHTML = '<p style="color:var(--text-dim);font-size:13px">No log entries yet.</p>';
      return;
    }
    el.innerHTML = '<div class="log-list">' + log.map(e => {
      const isErr = !!e.error;
      const status = isErr ? `<span class="log-status err">ERR</span>` : `<span class="log-status ok">${e.status_code}</span>`;
      const body = esc(e.error || e.response_body || '');
      return `<div class="log-entry ${isErr ? 'error' : 'success'}">
        <span class="log-time">${timeAgo(e.created_at)}</span>
        <span class="log-event">${esc(e.event_type)}</span>
        ${status}
        <span class="log-body">${body}</span>
      </div>`;
    }).join('') + '</div>';
  } catch (err) {
    el.innerHTML = `<p style="color:var(--danger);font-size:13px">${esc(err.message)}</p>`;
  }
}

async function testSelectedHook() {
  if (!selectedHookId) return;
  try {
    const result = await api('POST', `/hooks/${selectedHookId}/test`);
    if (result.success) {
      toast(`Test fired — HTTP ${result.status}`, 'success');
    } else {
      toast(`Test failed: ${result.error}`, 'error');
    }
    loadHookLog();
  } catch (e) {
    toast(`Test error: ${e.message}`, 'error');
  }
}

async function deleteSelectedHook() {
  if (!selectedHookId) return;
  if (!confirm(`Delete hook "${selectedHookId}"? This will remove all project subscriptions to it.`)) return;
  try {
    await api('DELETE', `/hooks/${selectedHookId}`);
    selectedHookId = null;
    toast('Hook deleted');
    await loadHooks();
    renderHooks();
    renderHookEditor();
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function saveHook() {
  if (!selectedHookId) return;
  const name = document.getElementById('he-name').value.trim();
  const url  = document.getElementById('he-url').value.trim();
  const method = document.getElementById('he-method').value;
  const enabled = document.getElementById('he-enabled').checked;
  const headersStr = document.getElementById('he-headers').value.trim();
  const body_template = document.getElementById('he-template').value.trim();

  if (!name || !url) { toast('Name and URL are required', 'error'); return; }

  let headers;
  if (headersStr) {
    try { headers = JSON.parse(headersStr); } catch (_) { toast('Headers must be valid JSON', 'error'); return; }
  }

  try {
    await api('PUT', `/hooks/${selectedHookId}`, { name, url, method, enabled, headers, body_template: body_template || null });
    toast('Hook saved', 'success');
    await loadHooks();
    renderHooks();
    renderHookEditor();
  } catch (e) {
    toast(e.message, 'error');
  }
}

function cancelHookEdit() {
  renderHookEditor();
}

// ════════════════════════════════════════════════════════════
// Project CRUD
// ════════════════════════════════════════════════════════════
async function createProject() {
  const name = document.getElementById('cp-name').value.trim();
  const id   = document.getElementById('cp-id').value.trim();
  const desc = document.getElementById('cp-desc').value.trim();
  const membersRaw = document.getElementById('cp-members').value.trim();

  if (!name) { toast('Name is required', 'error'); return; }

  const members = membersRaw ? membersRaw.split('\n')
    .map(l => l.trim()).filter(Boolean)
    .map(l => { const [n, r] = l.split(':'); return { name: n.trim(), role: (r || 'contributor').trim() }; })
    : [];

  try {
    await api('POST', '/projects', { name, id: id || undefined, description: desc || undefined, members });
    toast('Project created', 'success');
    closeModal('create-project');
    document.getElementById('cp-name').value = '';
    document.getElementById('cp-id').value = '';
    document.getElementById('cp-desc').value = '';
    document.getElementById('cp-members').value = '';
    await loadProjects();
    renderProjects();
    updateStatPill();
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function openEditProject(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  document.getElementById('ep-id').value = project.id;
  document.getElementById('ep-name').value = project.name;
  document.getElementById('ep-desc').value = project.description || '';
  document.getElementById('ep-archived').checked = !!project.archived;

  // Switch to details tab
  switchTab('ep', 'details');

  // Populate hook select
  const sel = document.getElementById('ep-sub-hook');
  sel.innerHTML = '<option value="">— select hook —</option>' +
    hooks.map(h => `<option value="${h.id}">${esc(h.name)}</option>`).join('');

  openModal('edit-project');

  // Load members
  renderEditMembers(project);

  // Load notifications
  loadEditNotifications(projectId);
}

function renderEditMembers(project) {
  const el = document.getElementById('ep-members-list');
  const members = project.members || [];
  if (!members.length) {
    el.innerHTML = '<p style="color:var(--text-dim);font-size:13px;margin-bottom:8px">No members yet.</p>';
    return;
  }
  el.innerHTML = members.map(m => `
    <div class="sub-item">
      <span class="member-badge ${m.role}">${esc(m.member_name)}</span>
      <span style="flex:1;font-size:12px;color:var(--text-dim)">${m.role}</span>
      <button class="btn-icon" onclick="removeMember('${m.member_name}')" style="font-size:12px">✕</button>
    </div>`).join('');
}

async function addMember() {
  const projectId = document.getElementById('ep-id').value;
  const name = document.getElementById('ep-member-name').value.trim();
  const role = document.getElementById('ep-member-role').value;
  if (!name) { toast('Member name is required', 'error'); return; }
  try {
    await api('POST', `/projects/${projectId}/members`, { name, role });
    document.getElementById('ep-member-name').value = '';
    await loadProjects();
    const project = projects.find(p => p.id === projectId);
    renderEditMembers(project);
    renderProjects();
    toast('Member added');
  } catch (e) { toast(e.message, 'error'); }
}

async function removeMember(name) {
  const projectId = document.getElementById('ep-id').value;
  try {
    await api('DELETE', `/projects/${projectId}/members/${encodeURIComponent(name)}`);
    await loadProjects();
    const project = projects.find(p => p.id === projectId);
    renderEditMembers(project);
    renderProjects();
    toast('Member removed');
  } catch (e) { toast(e.message, 'error'); }
}

async function loadEditNotifications(projectId) {
  const el = document.getElementById('ep-subs-list');
  try {
    const subs = await api('GET', `/projects/${projectId}/notifications`);
    if (!subs.length) {
      el.innerHTML = '<p style="color:var(--text-dim);font-size:13px;margin-bottom:8px">No hook subscriptions.</p>';
      return;
    }
    el.innerHTML = subs.map(s => `
      <div class="sub-item">
        <span class="sub-name">${esc(s.hook_name || s.hook_id)}</span>
        <span class="sub-filter">${s.event_filter || 'all events'}</span>
        <button class="btn-icon" onclick="removeSubscription('${s.hook_id}')" style="font-size:12px">✕</button>
      </div>`).join('');
  } catch (e) {
    el.innerHTML = `<p style="color:var(--danger);font-size:13px">${esc(e.message)}</p>`;
  }
}

async function addSubscription() {
  const projectId = document.getElementById('ep-id').value;
  const hookId = document.getElementById('ep-sub-hook').value;
  const eventFilter = document.getElementById('ep-sub-filter').value.trim();
  if (!hookId) { toast('Select a hook', 'error'); return; }
  try {
    await api('POST', `/projects/${projectId}/notifications`, {
      hook_id: hookId,
      event_filter: eventFilter || null
    });
    document.getElementById('ep-sub-filter').value = '';
    loadEditNotifications(projectId);
    toast('Subscribed');
  } catch (e) { toast(e.message, 'error'); }
}

async function removeSubscription(hookId) {
  const projectId = document.getElementById('ep-id').value;
  try {
    await api('DELETE', `/projects/${projectId}/notifications/${hookId}`);
    loadEditNotifications(projectId);
    toast('Unsubscribed');
  } catch (e) { toast(e.message, 'error'); }
}

async function saveProject() {
  const id   = document.getElementById('ep-id').value;
  const name = document.getElementById('ep-name').value.trim();
  const desc = document.getElementById('ep-desc').value.trim();
  const archived = document.getElementById('ep-archived').checked;

  if (!name) { toast('Name is required', 'error'); return; }

  try {
    await api('PUT', `/projects/${id}`, {
      name,
      description: desc || null,
      archived: archived ? 1 : 0
    });
    toast('Project saved', 'success');
    closeModal('edit-project');
    await loadProjects();
    renderProjects();
    updateStatPill();
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function archiveProject() {
  const id = document.getElementById('ep-id').value;
  const project = projects.find(p => p.id === id);
  if (!confirm(`Archive "${project?.name}"?`)) return;
  try {
    await api('DELETE', `/projects/${id}`);
    toast('Project archived');
    closeModal('edit-project');
    await loadProjects();
    renderProjects();
    updateStatPill();
  } catch (e) {
    toast(e.message, 'error');
  }
}

// ════════════════════════════════════════════════════════════
// Post Status
// ════════════════════════════════════════════════════════════
function openPostStatus(projectId, projectName) {
  document.getElementById('ps-project-id').value = projectId;
  document.getElementById('ps-project-label').textContent = `Project: ${projectName}`;
  document.getElementById('ps-text').value = '';
  openModal('post-status');
  document.getElementById('ps-author').focus();
}

async function postStatus() {
  const projectId = document.getElementById('ps-project-id').value;
  const author = document.getElementById('ps-author').value.trim();
  const text   = document.getElementById('ps-text').value.trim();

  if (!author) { toast('Author is required', 'error'); return; }
  if (!text)   { toast('Status text is required', 'error'); return; }

  try {
    await api('POST', `/projects/${projectId}/status`, { author, text });
    localStorage.setItem('pulse-author', author);
    toast('Status posted!', 'success');
    closeModal('post-status');
    historyCache[projectId] = null;  // Invalidate cache
    await loadProjects();
    renderProjects();
    // If expanded, reload history
    if (expandedProjectId === projectId) {
      await loadHistory(projectId);
      renderProjects();
    }
  } catch (e) {
    toast(e.message, 'error');
  }
}

// ════════════════════════════════════════════════════════════
// Create Hook
// ════════════════════════════════════════════════════════════
async function createHook() {
  const id   = document.getElementById('ch-id').value.trim();
  const name = document.getElementById('ch-name').value.trim();
  const url  = document.getElementById('ch-url').value.trim();
  const method = document.getElementById('ch-method').value;
  const headersStr = document.getElementById('ch-headers').value.trim();
  const body_template = document.getElementById('ch-template').value.trim();

  if (!id)   { toast('ID is required', 'error'); return; }
  if (!name) { toast('Name is required', 'error'); return; }
  if (!url)  { toast('URL is required', 'error'); return; }

  let headers;
  if (headersStr) {
    try { headers = JSON.parse(headersStr); } catch (_) { toast('Headers must be valid JSON', 'error'); return; }
  }

  try {
    await api('POST', '/hooks', { id, name, url, method, headers, body_template: body_template || null });
    toast('Hook created', 'success');
    closeModal('create-hook');
    document.getElementById('ch-id').value = '';
    document.getElementById('ch-name').value = '';
    document.getElementById('ch-url').value = '';
    document.getElementById('ch-headers').value = '';
    document.getElementById('ch-template').value = '';
    await loadHooks();
    renderHooks();
  } catch (e) {
    toast(e.message, 'error');
  }
}

const TEMPLATES = {
  slack: `{\n  "text": "📋 *{{project.name}}* — {{update.author}}: {{update.text}}"\n}`,
  openclaw: `{\n  "agentId": "clawd",\n  "channel": "telegram",\n  "accountId": "clawd",\n  "target": "YOUR_CHAT_ID",\n  "project": "{{project.name}}",\n  "author": "{{update.author}}",\n  "text": "{{update.text}}"\n}`,
  discord: `{\n  "content": "**{{project.name}}** — {{update.author}}: {{update.text}}"\n}`
};

function fillTemplate(type) {
  document.getElementById('ch-template').value = TEMPLATES[type] || '';
}

// ════════════════════════════════════════════════════════════
// Navigation
// ════════════════════════════════════════════════════════════
function showView(name) {
  currentView = name;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  document.getElementById(`tab-${name}`).classList.add('active');
}

function toggleArchivedFilter() {
  showArchived = !showArchived;
  const btn = document.getElementById('filter-archived');
  btn.classList.toggle('active', showArchived);
  btn.textContent = showArchived ? 'Hide archived' : 'Show archived';
  loadProjects().then(renderProjects);
}

// ════════════════════════════════════════════════════════════
// Modals
// ════════════════════════════════════════════════════════════
function openModal(name) {
  document.getElementById(`modal-${name}`).classList.add('open');
  // Focus first input
  const first = document.querySelector(`#modal-${name} input[type=text], #modal-${name} textarea`);
  if (first) setTimeout(() => first.focus(), 50);
}

function closeModal(name) {
  document.getElementById(`modal-${name}`).classList.remove('open');
}

// Keyboard: Escape to close
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
  }
  if (e.key === 'Enter' && e.metaKey) {
    // Cmd+Enter to submit active modal
    const form = document.querySelector('.modal-overlay.open');
    if (form) {
      const primaryBtn = form.querySelector('.modal-footer .btn-primary');
      if (primaryBtn) primaryBtn.click();
    }
  }
});

// ════════════════════════════════════════════════════════════
// Tabs
// ════════════════════════════════════════════════════════════
function switchTab(prefix, tab) {
  document.querySelectorAll(`[id^="${prefix}-tab-"]`).forEach(p => p.classList.remove('active'));
  document.querySelectorAll(`.tab-btn`).forEach(b => b.classList.remove('active'));
  document.getElementById(`${prefix}-tab-${tab}`).classList.add('active');
  // Find the button that switches to this tab
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${tab}'`)) {
      b.classList.add('active');
    }
  });
}

// ════════════════════════════════════════════════════════════
// Toast
// ════════════════════════════════════════════════════════════
function toast(msg, type = 'success') {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  container.appendChild(t);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => t.classList.add('show'));
  });
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 300);
  }, 3500);
}

// ════════════════════════════════════════════════════════════
// Utilities
// ════════════════════════════════════════════════════════════
function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr.includes('T') ? dateStr : dateStr + 'Z');
  const diff = Date.now() - d.getTime();
  if (isNaN(diff)) return dateStr;
  const secs = Math.floor(diff / 1000);
  if (secs < 60)  return 'just now';
  const mins = Math.floor(secs / 60);
  if (mins < 60)  return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30)  return `${days}d ago`;
  return d.toLocaleDateString();
}

// ════════════════════════════════════════════════════════════
// Auto-refresh
// ════════════════════════════════════════════════════════════
function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(async () => {
    if (document.hidden) return;
    const prev = projects.map(p => p.id + p.latest_at).join('|');
    await loadProjects();
    const next = projects.map(p => p.id + p.latest_at).join('|');
    if (prev !== next) {
      historyCache = {};  // Invalidate history on any change
      renderProjects();
      updateStatPill();
    }
  }, 30000);
}

// ════════════════════════════════════════════════════════════
// Init
// ════════════════════════════════════════════════════════════
(async function init() {
  // Restore author from localStorage
  const savedAuthor = localStorage.getItem('pulse-author');
  if (savedAuthor) document.getElementById('ps-author').value = savedAuthor;

  await loadAll();
  startAutoRefresh();
})();
</script>
</body>
</html>
